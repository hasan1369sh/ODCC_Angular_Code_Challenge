<div class="container-fluid">
  <div class="users-list">
    <p class="list-title">لیست کاربران</p>
    <dx-data-grid
      style="width: 100%; height: fit-content"
      #dataGrid
      id="dataGrid"
      [dataSource]="users"
      [keyExpr]="'id'"
      [noDataText]="'کاربری یافت نشد'"
      [allowColumnResizing]="true"
      [columnAutoWidth]="false"
      [showBorders]="true"
      [showRowLines]="true"
      [rowAlternationEnabled]="true"
      [hoverStateEnabled]="true"
      [allowColumnReordering]="true"
      [filterRow]="{ visible: true }"
      [searchPanel]="{ visible: true, placeholder: 'جستجو در کاربران...' }"
      (onToolbarPreparing)="onToolbarPreparing($event)"
      [paging]="{ pageSize: 10, pageIndex: 0 }"
      [columnMinWidth]="100"
      [wordWrapEnabled]="true"
      (onRowClick)="selectedUser($event)"
    >
      <!-- تصویر -->
      <dxi-column
        caption="تصویر پروفایل"
        dataField="profilePhoto"
        [allowSorting]="false"
        [allowFiltering]="false"
        cellTemplate="photoTemplate"
        [width]="120"
        alignment="center"
      >
      </dxi-column>

      <dxi-column alignment="center" caption="نام" dataField="firstName" [width]="120"></dxi-column>
      <dxi-column
        alignment="center"
        caption="نام خانوادگی"
        dataField="lastName"
        [width]="120"
      ></dxi-column>
      <dxi-column
        alignment="center"
        caption="سن"
        dataField="age"
        dataType="number"
        [width]="80"
      ></dxi-column>
      <dxi-column
        alignment="center"
        caption="تحصیلات"
        dataField="education"
        [width]="130"
      ></dxi-column>
      <dxi-column
        alignment="center"
        caption="کد ملی"
        dataField="nationalId"
        [width]="140"
      ></dxi-column>
      <dxi-column
        alignment="center"
        caption="تاریخ تولد"
        dataField="birthDate"
        dataType="date"
        format="yyyy/MM/dd"
        [width]="120"
      ></dxi-column>

      <!-- قالب تصویر -->
      <div *dxTemplate="let data of 'photoTemplate'">
        @if(data.value){
        <img [src]="data.value" alt="Profile" class="profile-photo" [name]="'grid_img'" />
        }@else {
        <ng-template #noPhoto>
          <div class="no-photo">
            <i class="dx-icon-user"></i>
          </div>
        </ng-template>
        }
      </div>
    </dx-data-grid>
  </div>
</div>


<!-- Popup -->
<dx-popup
  [width]="700"
  [height]="600"
  [showTitle]="true"
  [title]="
    popupMode?.forViewUser
      ? 'مشاهده اطلاعات کاربر'
      : popupMode?.forAddUser
      ? 'افزودن کاربر جدید'
      : popupMode?.forEditUser
      ? 'ویرایش کاربر انتخاب شده'
      : ''
  "
  [dragEnabled]="false"
  [hideOnOutsideClick]="false"
  [showCloseButton]="true"
  container="body"
  [(visible)]="isPopupVisible"
>
  <dxi-popup-toolbar-item
    widget="dxButton"
    toolbar="bottom"
    location="before"
    [options]="cancleButtonOptions"
  >
  </dxi-popup-toolbar-item>
  <dxi-popup-toolbar-item
    widget="dxButton"
    toolbar="bottom"
    location="after"
    [options]="insertButtonOptions"
  >
  </dxi-popup-toolbar-item>
  <dxo-position my="center top" at="center top" [offset]="{ x: 0, y: 32 }"> </dxo-position>
  <div *dxTemplate="let data of 'content'">
    <div
      style="
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
      "
    >
    <div style="width: 100%; height:235px">
      <div style="height: 50px; width: 150px; margin:0 auto ">
        <div style="text-align: center; margin-top: 1rem" >
            <img
            [name]="'popup_image'"
            [src]="currentUser.profilePhoto? currentUser.profilePhoto : '/images.png'"
            alt="پروفایل"
            style="max-width: 150px; border-radius: 4px;max-height: 150px"
          />
        </div>
        <dx-button
         [disabled]="popupMode?.forViewUser ?? false"
          style="
            border-bottom: 1px solid #b9b9b9;
            padding: 10px;
            cursor: pointer;
            text-align: center;
            width: 100% !important;
            height: 100%;
            background: rgb(243, 243, 243) !important;
            transition: background 0.2s;
          "
          (click)="fileInput.click()"
        >
          {{ currentUser.profilePhoto ? 'تغییر تصویر' : 'انتخاب تصویر' }}
        </dx-button>

        <input
         [disabled]="popupMode?.forViewUser"
          #fileInput
          type="file"
          accept="image/*"
          style="display: none"
          (change)="onFileSelected($event)"
        />

      </div>
    </div>
      <dx-text-box
        [disabled]="popupMode?.forViewUser ?? false"
        [(value)]="currentUser.firstName"
        placeholder="نام"
        width="49%"
        style="margin-bottom: 1rem"
        vali
      >
      <dx-validator>
          <dxi-validation-rule type="required" message="فیلد الزامی است"></dxi-validation-rule>
        </dx-validator>
    </dx-text-box>
      <dx-text-box [disabled]="popupMode?.forViewUser ?? false"
        [(value)]="currentUser.lastName"
        placeholder="نام خانوادگی"
        width="49%"
        style="margin-bottom: 1rem"
      >
      <dx-validator>
          <dxi-validation-rule type="required" message="فیلد الزامی است"></dxi-validation-rule>
        </dx-validator>
    </dx-text-box>
      <dx-text-box [disabled]="popupMode?.forViewUser ?? false"
        [(value)]="currentUser.nationalId"
        placeholder="کد ملی"
        width="49%"
        style="margin-bottom: 1rem"
      >
       <dx-validator>
          <dxi-validation-rule type="required" message="فیلد الزامی است"></dxi-validation-rule>
        </dx-validator>
    </dx-text-box>
      <dx-text-box [disabled]="popupMode?.forViewUser ?? false"
        [(value)]="currentUser.age"
        placeholder="سن"
        width="49%"
        style="margin-bottom: 1rem"
      >
       <dx-validator>
          <dxi-validation-rule type="required" message="فیلد الزامی است"></dxi-validation-rule>
        </dx-validator>
    </dx-text-box>
      <dx-select-box [disabled]="popupMode?.forViewUser ?? false"
        [(value)]="currentUser.education"
        [items]="educations"
        displayExpr="text"
        valueExpr="value"
        placeholder="تحصیلات"
        width="49%"
        style="margin-bottom: 1rem"
      >
       <dx-validator>
          <dxi-validation-rule type="required" message="فیلد الزامی است"></dxi-validation-rule>
        </dx-validator>
    </dx-select-box>
      <div style="width: 49%">
        <app-date-picker
          [name]="'birthDate'"
          [placeholder]="'تاریخ تولد'"
          [(ngModel)]="currentUser.birthDate"
        ></app-date-picker>
      </div>

    </div>
  </div>
</dx-popup>
